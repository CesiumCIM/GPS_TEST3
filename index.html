<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Cesium GPSリアルタイム追跡</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.89/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.89/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhZDE3MjMyZi01MThlLTQxOGQtOTM4ZC1iYjBlODFiMGM2Y2UiLCJpZCI6MjQ1NzQ4LCJpYXQiOjE3Mjc5NzY3ODJ9.pNoxj3_erzKOuSjKyj2A_LQXESK_jk9hg692mvX_3G0';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(),
      shouldAnimate: true
    });

    if (navigator.geolocation) {
      const terrainProvider = Cesium.createWorldTerrain();
      let gpsEntity = null;
      let firstUpdate = true;

      navigator.geolocation.watchPosition(
        function (position) {
          const lon = position.coords.longitude;
          const lat = position.coords.latitude;
          const point = Cesium.Cartographic.fromDegrees(lon, lat);

          Cesium.sampleTerrainMostDetailed(terrainProvider, [point]).then(function (updatedPositions) {
            const height = updatedPositions[0].height || 0;
            const cartesian = Cesium.Cartesian3.fromDegrees(lon, lat, height);

            if (!gpsEntity) {
              gpsEntity = viewer.entities.add({
                name: "現在地",
                position: cartesian,
                point: {
                  pixelSize: 12,
                  color: Cesium.Color.BLUE,
                  outlineColor: Cesium.Color.WHITE,
                  outlineWidth: 2
                },
                label: {
                  text: "現在地",
                  font: '16px sans-serif',
                  style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                  outlineWidth: 2,
                  verticalOrigin: Cesium.VerticalOrigin.TOP,
                  pixelOffset: new Cesium.Cartesian2(0, -20)
                }
              });

              // カメラを追従させる
              viewer.trackedEntity = gpsEntity;
            } else {
              gpsEntity.position = cartesian;
            }

            if (firstUpdate) {
              viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, height + 200)
              });
              firstUpdate = false;
            }
          });
        },
        function (error) {
          console.error("GPSエラー:", error);
          alert("GPSの取得に失敗しました: " + error.message);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000
        }
      );
    } else {
      alert("このブラウザはGPSに対応していません");
    }
  </script>
</body>
</html>
